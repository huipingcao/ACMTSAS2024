# GNNquery

This work is for using GNN to support graph queries. 


## Installation

### Neo4j Installation on Linux

[[official doc]](https://neo4j.com/docs/operations-manual/current/installation/linux/debian/#debian-add-repository)
[[easy-to-read blog]](https://linuxways.net/ubuntu/how-to-install-and-configure-neo4j-on-ubuntu-20-04/)


## Execution

### Build Maven Project 

- Add Maven support
- Project Structure -> make sure SDKs, working environment set correctly
- Build project via IDE or create an executable JAR on terminal


### Create an executable JAR with dependencies using Maven (maven-assembly-plugin)

`sudo apt install maven`
`mvn clean compile assembly:single`

- [stackoverflow](https://stackoverflow.com/questions/574594/how-can-i-create-an-executable-jar-with-dependencies-using-maven)
- [Create Executable Jar with Dependencies using Maven](http://www.javabyexamples.com/create-executable-jar-with-dependencies-using-maven)


### Absolute paths to be modified

```
ParsedOptions.java
GraphDatabaseBuilder in Neo4jDB.java
mapped_node_file in Query.java 
```


### Generate training samples and Comparison 

- One training sample is a set of skyline paths between two random pair of nodes.
- One dateset is consisted of given number of training samples, which can be transferred to geometric package compatible dataset while using the python code.
- All the script executable functions can be found in the  *~/GNNquery/Java_SkylineBBS/src/main/java/utilities/RunningScripts.java*. Here are some examples of java commands. You can run the executable jar file by compiling it from maven, or can run from you IDE. The provided example commands are only for demonstrated purposes. You can change parameters an you want.  

1. Create Neo4j Database from raw files. 
```
    >-m createDB -dbname <dbname> -neo4jdb <db_path> -GraphInfo <node_edge_file_path>
    >-m createDB -dbname C9_NY_CORR -neo4jdb /home/gqxwolf/mydata/backbone/testdb -GraphInfo /home/gqxwolf/mydata/projectData/BackBone/data/dataset/C9_NY_CORR
    >-m createDB -dbname C9_NY_CORR -neo4jdb /home/hchen/IntelliJProjects/java_SkylineGNN/Data/toy/db -GraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/toy
    >-m createDB -dbname C9_NY_CORR -neo4jdb /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY_CORR/db -GraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY_CORR
```

2. Generate a subgraph from a whole original graph. 
```
    >-m GenerateSubGraph -dbname <src-dbname> -neo4jdb <db_path> -GraphInfo <node_edge_file_path>
    >-m GenerateSubGraph -dbname C9_NY -neo4jdb /home/gqxwolf/shared_git/BackboneIndex/Data/Neo4jDB -GraphInfo /home/gqxwolf/shared_git/BackboneIndex/Data/C9_NY -sub_K 2 -outGraphInfo /home/gqxwolf/shared_git/BackboneIndex/Data/C9_NY_2K 
    >-m GenerateSubGraph -dbname C9_NY_CORR -neo4jdb /home/hchen/IntelliJProjects/java_SkylineGNN/Data/toy/db -GraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/toy -sub_K 2 -outGraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/toy/C9_NY_CORR_2K 
    >-m GenerateSubGraph -dbname C9_NY_CORR -neo4jdb /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY_CORR/db -GraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY_CORR -sub_K 3 -outGraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY_CORR/C9_NY_CORR_3K 
```
[TODO] >> **!Notes:** subGraphs for 3 types of relation should be topologically same, only update weights

3. Generate given number of training samples:
```
    > java -Xmx20G -jar BackboneIndex.jar -m GenerateBaselineResults -dbname <src_db_name> -neo4jdb <src_db> -GraphInfo <src_graph> -landmarkIndexFolder -nLandMark 3 -cLandMark true -resultFolder -numQuery 100 2>&1 | tee C9_NY_5K.log
    > java -Xmx20G -jar BackboneIndex.jar -m GenerateBaselineResults -dbname C9_BAY_80K -neo4jdb /home/gqxwolf/mydata/backbone/testdb -GraphInfo /home/gqxwolf/mydata/projectData/BackBone/data/dataset/C9_BAY/C9_BAY_80K -landmarkIndexFolder /home/gqxwolf/mydata/projectData/skylineGNN/landmarks/C9_BAY -nLandMark 3 -cLandMark true -resultFolder /home/gqxwolf/mydata/projectData/skylineGNN/results_back/C9_BAY/C9_BAY_80K/results -numQuery 100 2>&1 | tee C9_BAY_80K.log
    > java -Xmx20G -jar BackboneIndex.jar -m GenerateBaselineResults -dbname C9_NY_NONE_5K -neo4jdb /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY/db/C9_NY_NONE -GraphInfo /home/hchen/IntelliJProjects/java_SkylineGNN/Data/C9_NY/C9_NY_NONE/C9_NY_NONE_5K -landmarkIndexFolder /home/hchen/IntelliJProjects/java_SkylineGNN/Data/landmarks/C9_NY -nLandMark 3 -cLandMark true -resultFolder /home/hchen/IntelliJProjects/java_SkylineGNN/Data/results/C9_NY -numQuery 100 2>&1 | tee C9_NY_NONE_5K.log
```

4. Example code to compare approximate skyline paths on GNN generated subgraphs with the exact skyline solutions that search on the whole original graph. The subgraph mapping file is generated by the python file, *'SkylineGNN/utilities/validation_dataset.py'*.
```
    > -m compareBBS -dbname C9_BAY_30K -resultFolder /home/gqxwolf/mydata/projectData/skylineGNN/comparisonResults -indexFolder /home/gqxwolf/mydata/projectData/BackBone/indexes -landmarkIndexFolder /home/gqxwolf/mydata/projectData/BackBone/indexes/landmarks -neo4jdb /home/gqxwolf/mydata/backbone/testdb -nLandMark 3
    > -m compareBBS -dbname C9_NY_5K -resultFolder /home/gqxwolf/mydata/projectData/skylineGNN/comparisonResults -indexFolder /home/gqxwolf/mydata/projectData/BackBone/indexes -landmarkIndexFolder /home/gqxwolf/mydata/projectData/BackBone/indexes/landmarks
```

   

---
## Reference

- [pom ref](https://maven.apache.org/guides/introduction/introduction-to-the-pom.html)
- [Creating a deployment package using Eclipse](https://docs.aws.amazon.com/lambda/latest/dg/java-package-eclipse.html)
- [maven-assembly-plugin](https://maven.apache.org/plugins/maven-assembly-plugin/plugin-info.html)


## Troubleshooting

### Maven project CLASSPATH problem:

- no maven environment | no maven at Add framework support (project right click)
- import pom.xml as new maven project
- -> https://stackoverflow.com/questions/34338015/cannot-add-framework-support-in-intellij-14-ultimate
- -> https://stackoverflow.com/questions/43168072/intellij-idea-and-spring-and-maven-add-frameworks-support
- File->Project Structure->Modules->delete and reimport maven project->restart IDE
- View->Tool Window->Maven
- Run->New Maven Goal
- run maven project:
  https://www.jetbrains.com/help/idea/delegate-build-and-run-actions-to-maven.html#delegate_to_maven


### assembly: directory-single v.s. single

```xml
    <execution>
        <id>make-assembly</id>
        <!-- bind to the packaging phase -->
        <phase>package</phase>
        <goals>
            <goal>directory-single</goal>
            <goal>single</goal>
        </goals>
    </execution>
```

[link](http://www.mtitek.com/tutorials/maven/maven-plugin-assembly.php) directory-single: Like the assembly:attached goal, assemble an application bundle or distribution from an assembly descriptor. 
This goal differs from assembly:single in that it ignores the <formats/> section of the assembly descriptor, 
and forces the assembly to be created as a directory in the project''s build-output directory (usually ./target).